<!-- users/templates/users/register.html -->
{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Register - WePool Tribe{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Header Section -->
            <div class="text-center mb-4">
                <h2 class="mb-2">Join WePool Tribe</h2>
                <p class="text-muted">Start your journey with our community today</p>
            </div>
            
            <div class="card">
                <div class="card-header text-center">
                    <h4 class="mb-0">
                        <i class="fas fa-user-plus text-primary me-2"></i>Create Your Account
                    </h4>
                </div>
                <div class="card-body">
                    <form method="post" id="registration-form">
                        {% csrf_token %}

                        <div class="form-section mb-4">
                            <div class="section-header">
                                <h5 class="section-title">
                                    <i class="fas fa-user text-primary me-2"></i>Account Information
                                </h5>
                                <p class="section-subtitle">Basic login credentials for your account</p>
                            </div>
                            {{ user_form|crispy }}
                        </div>

                        <div class="form-section mb-4">
                            <div class="section-header">
                                <h5 class="section-title">
                                    <i class="fas fa-id-card text-primary me-2"></i>Profile Information
                                </h5>
                                <p class="section-subtitle">Tell us more about yourself</p>
                            </div>
                            {{ profile_form|crispy }}
                        </div>

                        <!-- Terms and Conditions -->
                        <div class="form-section mb-4">
                            <div class="section-header">
                                <h5 class="section-title">
                                    <i class="fas fa-file-contract text-primary me-2"></i>Terms and Conditions
                                </h5>
                                <p class="section-subtitle">Please read and accept our terms to continue</p>
                            </div>
                            <div class="terms-container">
                                <div class="terms-scrollbox" style="max-height: 300px; overflow-y: auto; border: 2px solid var(--border-color); border-radius: var(--radius-lg); background: white;">
                                {% include 'partials/terms_content.html' %}
                            </div>
                        </div>

                        <!-- Terms Agreement and Communications Opt-in -->
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="agreed_to_terms" name="agreed_to_terms" required>
                            <label class="form-check-label" for="agreed_to_terms">
                                <strong>I agree to the WePool Tribe Terms and Conditions *</strong>
                            </label>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="communications_opt_in" name="communications_opt_in">
                            <label class="form-check-label" for="communications_opt_in">
                                I agree to receive communications from WePool Tribe (recommended)
                            </label>
                        </div>

                        <div class="form-actions mt-4">
                            <button type="submit" class="btn btn-primary btn-lg w-100 mb-3">
                                <i class="fas fa-user-plus me-2"></i>Create My Account
                            </button>
                            <div class="text-center">
                                <p class="mb-0">Already have an account? 
                                    <a href="{% url 'login' %}" class="text-decoration-none fw-medium">Sign in here</a>
                                </p>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Check if referrer exists
document.getElementById('id_referrer_phone')?.addEventListener('blur', function() {
    const phone = this.value;
    if (phone && phone.match(/^\d+$/)) {  // Only check if it's all digits
        fetch(`{% url 'check_referrer' %}?phone=${phone}`)
            .then(response => response.json())
            .then(data => {
                const feedback = this.parentNode.querySelector('.feedback');
                if (feedback) feedback.remove();

                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'feedback';

                if (data.exists) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                    feedbackDiv.className += ' valid-feedback';
                    feedbackDiv.textContent = `Referrer: ${data.name} (${data.member_type === 'sponsored' ? 'PIF Member' : 'Paying Member'})`;
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                    feedbackDiv.className += ' invalid-feedback';
                    feedbackDiv.textContent = 'Referrer phone number not found';
                }
                this.parentNode.appendChild(feedbackDiv);
            });
    }
});

// Restrict phone inputs to numbers only
document.querySelectorAll('input[type="tel"]').forEach(input => {
    input.addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '');
    });
});

// Form validation
document.getElementById('registration-form').addEventListener('submit', function(e) {
    const termsCheckbox = document.getElementById('agreed_to_terms');
    if (!termsCheckbox.checked) {
        e.preventDefault();
        alert('You must agree to the Terms and Conditions to proceed.');
        termsCheckbox.focus();
    }
});
</script>

<style>
.form-section {
    background: linear-gradient(135deg, #f8fafc 0%, white 100%);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    border: 1px solid var(--border-color);
}

.section-header {
    margin-bottom: 1rem;
}

.section-title {
    color: var(--text-primary);
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.section-subtitle {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-bottom: 0;
}

.terms-container {
    background: white;
    border-radius: var(--radius-lg);
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.terms-scrollbox {
    padding: 1.5rem;
}

.form-actions {
    background: linear-gradient(135deg, #f8fafc 0%, white 100%);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    border: 1px solid var(--border-color);
}
</style>
{% endblock %}